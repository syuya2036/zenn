---
title: "PythonÃ—Next.jsÃ—PostgreSQLã®ç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker", "Python", "Next.js", "PostgreSQL"]
published: true
---

# ã¯ã˜ã‚ã«

langchainã‚’ä½¿ã£ãŸå€‹äººé–‹ç™ºã‚’ã™ã‚‹ãŸã‚ã«PythonÃ—Next.jsÃ—PostgreSQLã®ç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰ã—ãŸã®ã§ã€å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

å„ç’°å¢ƒã‚’Dockerfileã§å®šç¾©ã—ã¦ã€docker-composeã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```bash
.
â”œâ”€â”€ front
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ ai
â”‚   â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ db
â””â”€â”€ docker-compose.yml

```

front, ai_service(api), ai_dbã®3ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€ã“ã‚Œã‚‰ã‚’docker-composeã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

# æ‰‹é †

## docker-compose.ymlã®ä½œæˆ

ã¾ãšæœ€åˆã«docker-compose.ymlã‚’ä½œæˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```yml
version: '3.8'

services:
  front:
    build:
      context: ./front
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - ai_service
    volumes:
      - ./front:/app

  ai_service:
    build:
      context: ./services/ai/api
    ports:
      - "5000:5000"
    depends_on:
      - ai_db

  ai_db:
    image: postgres:15
    volumes:
      - ./services/ai/db/init:/docker-entrypoint-initdb.d
      - ./services/ai/db/data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: passw0rd
    ports:
      - "5432:5432"
```

db -> api -> frontã®é †ç•ªã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## db

ã¾ãšæœ€åˆã«dbã‚’ä½œæˆã—ã¾ã™ã€‚dbã§ã¯Dockerfileã‚’ä½¿ã‚ãšã€docker-compose.ymlã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

ã“ã®éƒ¨åˆ†ã§ã™ã€‚
```yml
  ai_db:
	image: postgres:15
	volumes:
	  - ./services/ai/db/init:/docker-entrypoint-initdb.d
	  - ./services/ai/db/data:/var/lib/postgresql/data
	environment:
	  POSTGRES_DB: postgres
	  POSTGRES_USER: postgres
	  POSTGRES_PASSWORD: passw0rd
	ports:
	  - "5432:5432"
```

### init

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã¨ã€`/docker-entrypoint-initdb.d`ã«ã‚ã‚‹SQLãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ä»Šå›ã¯ã€`init`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`init.sql`ã‚’ä½œæˆã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹SQLã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

```sql
DROP TABLE IF EXISTS messages;

CREATE TABLE IF NOT EXISTS messages(
    id serial PRIMARY KEY,
    title text NOT NULL,
    body text NOT NULL
);

INSERT INTO messages (title, body) VALUES ('Initial Message', 'hello from python');
```

ã“ã‚Œã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```bash
$ docker compose exec ai_db psql -U postgres -d postgres -c "\dt"
		List of relations
 Schema |  Name   | Type  | Owner
--------+---------+-------+--------
 public | messages | table | postgres
(1 row)
```

```bash
$ docker compose exec ai_db psql -U postgres -d postgres -c "select * from messages"
 id |      title       |       body
----+------------------+-------------------
  1 | Initial Message  | hello from python
(1 row)
```

### ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

é–‹ç™ºä¸­ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¦ã—ã¾ã†ã®ã§ã€ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```yml
  ai_db:
	image: postgres:15
	volumes:
	  - ./services/ai/db/init:/docker-entrypoint-initdb.d
	  - ./services/ai/db/data:/var/lib/postgresql/data   <<< ã“ã“
```
/services/ai/db/data:/var/lib/postgresql/dataã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

## api

æ¬¡ã«apiã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ app.py
â”œâ”€â”€ health
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ health.py
â””â”€â”€ requirements.txt
```

health.pyã¯apiã®å‹•ä½œç¢ºèªç”¨ã«ä½œæˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã€app.pyã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã¾ãšä»¥ä¸‹ã®ã‚ˆã†ã«Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚

```Dockerfile
FROM python:3.10
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt

EXPOSE 5000

CMD ["python", "app.py"]
```

### requirements.txt

apiã§ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```txt
Flask
flask-cors
psycopg2-binary
```

- Flask: Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- flask-cors: CORSå¯¾å¿œ
- psycopg2-binary: PostgreSQLã‚’ä½¿ã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

### app.py

apiã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯app.pyã§ã™ã€‚

```python
from flask import Flask
from flask_cors import CORS
from health.health import health_bp

app = Flask(__name__)
CORS(app)

app.register_blueprint(health_bp, url_prefix='/api')

if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0', port=5000)
```

### health

apiã®å‹•ä½œç¢ºèªç”¨ã«healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚å‹•ä½œç¢ºèªç”¨ã«`health`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ã¾ãŸã€frontã‹ã‚‰apiã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã€CORSå¯¾å¿œã‚’ã—ã¦ã„ã¾ã™ã€‚

```python
from flask import Blueprint, jsonify
import psycopg2
import os

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’å–å¾—ï¼ˆé©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
DATABASE_URL = os.getenv('DATABASE_URL', 'postgresql://postgres:passw0rd@ai_db:5432/postgres')
conn = psycopg2.connect(DATABASE_URL)
cur = conn.cursor()

health_bp = Blueprint('health', __name__)

@health_bp.route('/health', methods=['GET'])
def health_check():
    return jsonify({"status": "healthy"}), 200

@health_bp.route('/greeting', methods=['GET'])
def greeting():
    conn = None
    try:
        cur.execute('SELECT body FROM messages ORDER BY id LIMIT 1')
        body = cur.fetchone()
        if body:
            return jsonify({"message": body[0]}), 200
        else:
            return jsonify({"message": "No message found"}), 404
    except (Exception, psycopg2.DatabaseError) as error:
        return jsonify({"error": str(error)}), 500
    finally:
        if conn is not None:
            conn.close()
```

å…ˆã»ã©ä½œæˆã—ãŸdbã‚³ãƒ³ãƒ†ãƒŠã¨ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚Šã€`messages`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

## front

æœ€å¾Œã«frontã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä»®ã®Dockerfileã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```yml
FROM node:21-alpine

WORKDIR /app/
```

ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ã¦ã€`npx create-next-app`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ãŸã‚‰Dockerfileã‚’ä¸€æ—¦å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
$ docker compose run --rm front sh
/app # rm Dockerfile
/app # npx create-next-app .
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’æŠœã‘ã¦ã€Dockerfileã‚’å†åº¦ä½œæˆã—ã¾ã™ã€‚

```yml
FROM node:21-alpine

WORKDIR /app/

COPY . .

RUN npm install

EXPOSE 3000

CMD ["npm", "run", "dev"]
```

ã¾ãŸã€page.tsxã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```tsx
export default async function Home() {
  const data = await fetch('http://ai_service:5000/api/greeting', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    }
  });

  const greeting = await data.json()

  return (
    <div>
      <h1>{greeting.message}</h1>
      <p>nextjsã§æç”»ã—ã¦ã„ã¾ã™</p>
    </div>
  )
}
```

`fetch`ã®URLã‚’`http://ai_service:5000/api/greeting`ã«ã—ã¦ã„ã¾ã™ã€‚`ai_service`ã¯docker-compose.ymlã§å®šç¾©ã—ãŸã‚³ãƒ³ãƒ†ãƒŠåã§ã™ã€‚

# èµ·å‹•

```bash
$ docker compose up -d
```

`localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`hello from python`ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚

çµ‚äº†ã™ã‚‹ã¨ãã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ docker compose down
```

ã¾ãŸã€å†ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ãã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ docker compose up -d --build
```

# ãŠã‚ã‚Šã«

ä»Šå›ã¯ã€PythonÃ—Next.jsÃ—PostgreSQLã®ç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰ã—ã¾ã—ãŸã€‚
